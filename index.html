<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CampusEdge Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
/* ============================================================
   VARIABLES — Light & Dark
============================================================ */
:root {
  --red:#c0392b; --red-dark:#96281b; --red-light:#f8e8e6; --red-mid:#e8b4af;
  --sidebar:#18100f; --sidebar-t:rgba(255,255,255,.65);
  --white:#fff; --bg:#f5f2ef; --bg2:#ece8e4; --border:#e4dfd9;
  --dark:#1a1210; --text:#3a2e2b; --text-light:#9c8c87;
  --success:#27ae60; --warning:#e67e22; --info:#2980b9;
  --card-bg:#fff; --input-bg:#fff; --topbar-bg:#fff;
  --shadow-sm:0 1px 4px rgba(0,0,0,.06),0 2px 8px rgba(0,0,0,.04);
  --shadow:0 4px 16px rgba(0,0,0,.09),0 1px 4px rgba(0,0,0,.04);
  --shadow-lg:0 8px 32px rgba(0,0,0,.13),0 2px 8px rgba(0,0,0,.06);
  --r:14px; --r-sm:8px; --sw:256px; --th:62px;
  --tr:.2s cubic-bezier(.4,0,.2,1);
}
[data-theme="dark"] {
  --white:#1e1512; --bg:#150f0d; --bg2:#1e1512; --border:#2e201c;
  --dark:#f0e8e4; --text:#d4c5be; --text-light:#7a6a64;
  --card-bg:#1e1512; --input-bg:#251a16; --topbar-bg:#1a110e;
  --shadow-sm:0 1px 4px rgba(0,0,0,.3),0 2px 8px rgba(0,0,0,.2);
  --shadow:0 4px 16px rgba(0,0,0,.4),0 1px 4px rgba(0,0,0,.2);
  --shadow-lg:0 8px 32px rgba(0,0,0,.5),0 2px 8px rgba(0,0,0,.3);
  --red-light:rgba(192,57,43,.15); --red-mid:rgba(192,57,43,.3);
}

/* ============================================================
   RESET & BASE
============================================================ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;font-size:15px;line-height:1.6;overflow-x:hidden;transition:background var(--tr),color var(--tr);}

/* ============================================================
   SIDEBAR
============================================================ */
.sidebar{position:fixed;left:0;top:0;width:var(--sw);height:100vh;background:var(--sidebar);display:flex;flex-direction:column;z-index:100;transition:transform var(--tr);overflow:hidden;}
.sidebar::before{content:'';position:absolute;top:-50px;right:-50px;width:180px;height:180px;border-radius:50%;background:radial-gradient(circle,rgba(192,57,43,.22) 0%,transparent 70%);pointer-events:none;}
.sb-brand{display:flex;align-items:center;gap:11px;padding:22px 18px 24px;border-bottom:1px solid rgba(255,255,255,.07);}
.sb-icon{width:38px;height:38px;border-radius:9px;background:var(--red);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sb-name{font-family:'DM Serif Display',serif;font-size:1.1rem;color:#fff;display:block;line-height:1.1;}
.sb-tag{font-size:.6rem;font-weight:700;color:var(--red);background:rgba(192,57,43,.2);padding:1px 7px;border-radius:20px;letter-spacing:.1em;text-transform:uppercase;}
.sb-nav{flex:1;padding:18px 12px;overflow-y:auto;}
.nav-lbl{font-size:.67rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.28);padding:0 8px;margin-bottom:7px;margin-top:4px;}
.nav-item{display:flex;align-items:center;gap:11px;padding:10px 13px;border-radius:9px;color:var(--sidebar-t);text-decoration:none;font-size:.88rem;font-weight:400;transition:all var(--tr);margin-bottom:2px;cursor:pointer;user-select:none;}
.nav-item:hover{background:rgba(255,255,255,.08);color:#fff;}
.nav-item.active{background:var(--red);color:#fff;font-weight:500;box-shadow:0 4px 14px rgba(192,57,43,.4);}
.nav-item svg{flex-shrink:0;opacity:.8;}
.nav-item.active svg{opacity:1;}
.sb-footer{padding:14px 16px;border-top:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:9px;}
.stu-avatar{width:34px;height:34px;border-radius:50%;background:var(--red);color:#fff;font-weight:700;font-size:.88rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.stu-details{flex:1;overflow:hidden;}
.stu-name{display:block;color:#fff;font-size:.83rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.stu-sem{display:block;color:rgba(255,255,255,.38);font-size:.7rem;}
.sb-footer-btns{display:flex;gap:5px;}
.btn-sb-icon{width:28px;height:28px;border-radius:7px;background:rgba(255,255,255,.07);border:none;color:rgba(255,255,255,.45);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--tr);flex-shrink:0;}
.btn-sb-icon:hover{background:rgba(192,57,43,.3);color:#fff;}

/* ============================================================
   MAIN & TOPBAR
============================================================ */
.main{flex:1;margin-left:var(--sw);min-height:100vh;display:flex;flex-direction:column;transition:margin var(--tr);}
.topbar{height:var(--th);background:var(--topbar-bg);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 30px;position:sticky;top:0;z-index:50;transition:background var(--tr);}
.topbar-l{display:flex;align-items:center;gap:14px;}
.sb-toggle{display:none;flex-direction:column;gap:5px;background:none;border:none;cursor:pointer;padding:4px;}
.sb-toggle span{display:block;width:21px;height:2px;background:var(--text);border-radius:2px;transition:background var(--tr);}
.tb-crumb{font-size:.9rem;font-weight:600;color:var(--text);}
.topbar-r{display:flex;align-items:center;gap:12px;}
.tb-date{font-size:.8rem;color:var(--text-light);}
.tb-stu{font-size:.86rem;font-weight:600;background:var(--red-light);color:var(--red-dark);padding:5px 13px;border-radius:20px;}
.btn-theme{background:var(--bg2);border:1px solid var(--border);color:var(--text-light);width:34px;height:34px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--tr);}
.btn-theme:hover{color:var(--red);border-color:var(--red);}

/* ============================================================
   VIEWS
============================================================ */
.view{display:none;padding:34px 34px 60px;flex:1;animation:fadeUp .22s ease;}
.view.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(7px);}to{opacity:1;transform:translateY(0);}}
.view-hdr{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:30px;gap:14px;flex-wrap:wrap;}
.view-title{font-family:'DM Serif Display',serif;font-size:1.95rem;color:var(--dark);line-height:1.15;letter-spacing:-.02em;}
.view-sub{font-size:.88rem;color:var(--text-light);margin-top:3px;}

/* ============================================================
   BUTTONS
============================================================ */
.btn{display:inline-flex;align-items:center;gap:7px;padding:10px 20px;border-radius:9px;font-size:.86rem;font-weight:600;cursor:pointer;transition:all var(--tr);font-family:'DM Sans',sans-serif;border:none;white-space:nowrap;}
.btn-primary{background:var(--red);color:#fff;}
.btn-primary:hover{background:var(--red-dark);transform:translateY(-1px);box-shadow:0 5px 18px rgba(192,57,43,.35);}
.btn-secondary{background:var(--card-bg);color:var(--success);border:2px solid var(--success);}
.btn-secondary:hover{background:#f0fff4;transform:translateY(-1px);}
.btn-ghost{background:transparent;color:var(--text-light);border:1.5px solid var(--border);}
.btn-ghost:hover{background:var(--bg);color:var(--text);}
.btn-danger-ghost{background:none;border:none;color:var(--text-light);cursor:pointer;padding:6px;border-radius:6px;display:flex;align-items:center;transition:all var(--tr);}
.btn-danger-ghost:hover{color:var(--red);background:var(--red-light);}
.btn-edit-ghost{background:none;border:none;color:var(--text-light);cursor:pointer;padding:6px;border-radius:6px;display:flex;align-items:center;transition:all var(--tr);}
.btn-edit-ghost:hover{color:var(--info);background:#e8f4fd;}
.btn-sm{padding:7px 14px;font-size:.8rem;}
.btn-full{width:100%;justify-content:center;}

/* ============================================================
   STAT CARDS
============================================================ */
.stats-grid{display:grid;grid-template-columns:1.6fr 1fr 1fr 1fr;gap:18px;margin-bottom:24px;}
.stat-card{background:var(--card-bg);border-radius:var(--r);padding:22px;box-shadow:var(--shadow-sm);border:1px solid var(--border);position:relative;overflow:hidden;transition:box-shadow var(--tr),transform var(--tr),background var(--tr);}
.stat-card:hover{box-shadow:var(--shadow);transform:translateY(-2px);}
.stat-main{background:var(--red);border-color:var(--red);color:#fff;}
.stat-main .stat-lbl{color:rgba(255,255,255,.72);}
.stat-main .stat-mention{color:rgba(255,255,255,.82);}
.stat-deco{position:absolute;right:-18px;top:-18px;width:110px;height:110px;border-radius:50%;background:rgba(255,255,255,.09);pointer-events:none;}
.stat-lbl{font-size:.73rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--text-light);margin-bottom:7px;}
.stat-val{font-family:'DM Serif Display',serif;font-size:3rem;line-height:1;color:#fff;letter-spacing:-.03em;margin-bottom:5px;transition:font-size .2s;}
.stat-val-sm{font-size:2.3rem;color:var(--dark);}
.stat-mention{font-size:.86rem;font-weight:500;}
.stat-icon{width:38px;height:38px;border-radius:9px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;}
.si-blue{background:#e8f4fd;color:var(--info);}
.si-green{background:#e8f8ef;color:var(--success);}
.si-orange{background:#fef3e7;color:var(--warning);}
.stat-sub{font-size:.76rem;color:var(--text-light);margin-top:3px;}

/* OBJECTIF & PROGRESSION CARD */
.goal-bar-wrap{margin-top:10px;}
.goal-bar-track{height:6px;background:rgba(255,255,255,.2);border-radius:6px;overflow:hidden;}
.goal-bar-fill{height:100%;background:rgba(255,255,255,.9);border-radius:6px;transition:width .8s ease;}
.goal-hint{font-size:.76rem;color:rgba(255,255,255,.7);margin-top:5px;}
.progression-card{background:var(--card-bg);border-radius:var(--r);padding:18px 22px;box-shadow:var(--shadow-sm);border:1px solid var(--border);margin-bottom:24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;transition:background var(--tr);}
.prog-label{font-size:.8rem;font-weight:600;color:var(--text-light);letter-spacing:.04em;text-transform:uppercase;flex-shrink:0;}
.prog-track{flex:1;min-width:120px;height:8px;background:var(--bg2);border-radius:8px;overflow:hidden;}
.prog-fill{height:100%;border-radius:8px;transition:width .8s ease;}
.prog-text{font-size:.85rem;color:var(--text);font-weight:500;flex-shrink:0;}
.goal-input-row{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.goal-input-row label{font-size:.78rem;color:var(--text-light);}
.goal-input{width:70px;padding:5px 9px;border:1.5px solid var(--border);border-radius:7px;font-size:.86rem;font-family:'DM Sans',sans-serif;background:var(--input-bg);color:var(--dark);outline:none;transition:border-color var(--tr);}
.goal-input:focus{border-color:var(--red);}

/* ============================================================
   SECTION TITLE
============================================================ */
.sec-title-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.sec-title{font-family:'DM Serif Display',serif;font-size:1.25rem;color:var(--dark);letter-spacing:-.01em;}

/* ============================================================
   DASHBOARD MODULE OVERVIEW
============================================================ */
.mod-overview{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;}
.mod-ov-card{background:var(--card-bg);border-radius:var(--r);padding:20px;box-shadow:var(--shadow-sm);border:1px solid var(--border);transition:all var(--tr);}
.mod-ov-card:hover{box-shadow:var(--shadow);transform:translateY(-2px);}
.mod-ov-name{font-weight:600;font-size:.93rem;color:var(--dark);margin-bottom:5px;}
.mod-ov-avg{font-family:'DM Serif Display',serif;font-size:1.9rem;color:var(--red);letter-spacing:-.02em;line-height:1;margin-bottom:3px;}
.mod-ov-meta{font-size:.78rem;color:var(--text-light);}
.mod-ov-bar{margin-top:11px;height:4px;background:var(--bg2);border-radius:4px;overflow:hidden;}
.mod-ov-fill{height:100%;background:var(--red);border-radius:4px;transition:width .6s ease;}

/* ============================================================
   MODULES LIST — DRAG & DROP
============================================================ */
.mods-list{display:flex;flex-direction:column;gap:18px;}
.mod-block{background:var(--card-bg);border-radius:var(--r);box-shadow:var(--shadow-sm);border:1px solid var(--border);overflow:hidden;transition:box-shadow var(--tr),background var(--tr),opacity var(--tr),transform var(--tr);}
.mod-block.dragging{opacity:.5;box-shadow:var(--shadow-lg);transform:scale(1.01);}
.mod-block.drag-over{border:2px dashed var(--red);}
.mod-block-hdr{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);gap:10px;flex-wrap:wrap;}
.mod-block-title{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
.drag-handle{cursor:grab;color:var(--text-light);opacity:.5;flex-shrink:0;display:flex;align-items:center;transition:opacity var(--tr);}
.drag-handle:hover{opacity:1;}
.drag-handle:active{cursor:grabbing;}
.mod-dot{width:9px;height:9px;background:var(--red);border-radius:50%;flex-shrink:0;}
.mod-name{font-size:1rem;font-weight:600;color:var(--dark);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.mod-avg-badge{background:var(--red-light);color:var(--red-dark);font-weight:700;font-size:.78rem;padding:3px 10px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
.mod-block-actions{display:flex;align-items:center;gap:4px;flex-shrink:0;}

/* TABLE */
.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.tbl{width:100%;border-collapse:collapse;font-size:.86rem;min-width:520px;}
.tbl thead tr{background:var(--bg);}
.tbl th{text-align:left;padding:9px 14px;font-size:.7rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text-light);border-bottom:1px solid var(--border);}
.tbl td{padding:11px 14px;border-bottom:1px solid var(--border);color:var(--text);vertical-align:middle;}
.tbl tbody tr:last-child td{border-bottom:none;}
.tbl tbody tr:hover td{background:var(--bg);}
.cell-name{font-weight:500;color:var(--dark);}
.cell-hint{font-size:.74rem;color:var(--text-light);margin-top:2px;}
.gb{display:inline-block;background:var(--bg);border-radius:5px;padding:3px 9px;font-weight:600;font-size:.83rem;color:var(--dark);}
.gb-final{background:var(--red-light);color:var(--red-dark);}
.gb-good{background:#e8f8ef;color:#196f3d;}
.gb-bad{background:#fdecea;color:#922b21;}
.cred-pill{background:#eef2ff;color:#3d5aab;border-radius:20px;padding:3px 9px;font-size:.78rem;font-weight:600;}
[data-theme="dark"] .cred-pill{background:rgba(61,90,171,.2);color:#7b9ff7;}
[data-theme="dark"] .gb{background:var(--bg2);color:var(--dark);}
[data-theme="dark"] .gb-good{background:rgba(39,174,96,.15);color:#5dca85;}
[data-theme="dark"] .gb-bad{background:rgba(192,57,43,.15);color:#e88a80;}
.mod-add-row{padding:12px 18px;border-top:1px dashed var(--border);}
.btn-add-sub{background:none;border:1.5px dashed var(--border);color:var(--text-light);font-size:.81rem;font-family:'DM Sans',sans-serif;padding:7px 14px;border-radius:7px;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:all var(--tr);}
.btn-add-sub:hover{border-color:var(--red);color:var(--red);background:var(--red-light);}

/* VALIDATION FEEDBACK */
.fi-wrap{position:relative;}
.fi-valid::after{content:'✓';position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--success);font-size:.85rem;font-weight:700;}
.fi-invalid::after{content:'✗';position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--red);font-size:.85rem;font-weight:700;}
.fi.valid{border-color:var(--success) !important;}
.fi.invalid{border-color:var(--red) !important;}

/* ============================================================
   ANALYTICS
============================================================ */
.analytics-grid{display:grid;grid-template-columns:1.4fr 1fr;gap:18px;margin-bottom:18px;}
.chart-card{background:var(--card-bg);border-radius:var(--r);padding:22px;box-shadow:var(--shadow-sm);border:1px solid var(--border);transition:background var(--tr);}
.chart-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.chart-hdr h3{font-size:.95rem;font-weight:600;color:var(--dark);}
.legend{display:flex;align-items:center;gap:5px;font-size:.78rem;color:var(--text-light);}
.legend-dot{width:8px;height:8px;border-radius:50%;}
.chart-wrap{position:relative;height:230px;}
.tbl-card{background:var(--card-bg);border-radius:var(--r);padding:22px;box-shadow:var(--shadow-sm);border:1px solid var(--border);transition:background var(--tr);}

/* ============================================================
   HISTORIQUE SEMESTRES
============================================================ */
.hist-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-top:20px;}
.hist-card{background:var(--card-bg);border-radius:var(--r);padding:20px;box-shadow:var(--shadow-sm);border:1px solid var(--border);transition:all var(--tr);}
.hist-card:hover{box-shadow:var(--shadow);}
.hist-card-name{font-weight:700;font-size:.95rem;color:var(--dark);margin-bottom:4px;}
.hist-card-date{font-size:.76rem;color:var(--text-light);margin-bottom:12px;}
.hist-card-stats{display:flex;gap:16px;flex-wrap:wrap;}
.hist-stat{display:flex;flex-direction:column;}
.hist-stat-val{font-family:'DM Serif Display',serif;font-size:1.5rem;color:var(--red);line-height:1;}
.hist-stat-lbl{font-size:.72rem;color:var(--text-light);}
.hist-card-actions{display:flex;gap:8px;margin-top:14px;padding-top:14px;border-top:1px solid var(--border);}
.archive-banner{background:var(--card-bg);border:2px dashed var(--border);border-radius:var(--r);padding:22px 26px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:10px;transition:background var(--tr);}
.archive-banner-text{font-size:.9rem;color:var(--text);}
.archive-banner-text strong{color:var(--dark);}

/* ============================================================
   EXPORT
============================================================ */
.exp-profile{background:var(--card-bg);border-radius:var(--r);padding:26px;box-shadow:var(--shadow-sm);border:1px solid var(--border);margin-bottom:22px;transition:background var(--tr);}
.exp-profile h3{font-size:.95rem;font-weight:600;color:var(--dark);margin-bottom:18px;}
.form-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:15px;}
.form-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:13px;}
.fg{display:flex;flex-direction:column;gap:5px;}
.fg label{font-size:.73rem;font-weight:700;letter-spacing:.05em;text-transform:uppercase;color:var(--text-light);}
.lhint{font-weight:400;text-transform:none;letter-spacing:0;}
.fi{width:100%;padding:9px 13px;border:1.5px solid var(--border);border-radius:var(--r-sm);font-size:.88rem;font-family:'DM Sans',sans-serif;color:var(--dark);background:var(--input-bg);outline:none;transition:border-color var(--tr),box-shadow var(--tr),background var(--tr);}
.fi:focus{border-color:var(--red);box-shadow:0 0 0 3px rgba(192,57,43,.12);}
.fi::placeholder{color:var(--text-light);}
.fi-lg{font-size:1.05rem;padding:12px 15px;}
.ferr{background:var(--red-light);color:#922b21;border:1px solid var(--red-mid);border-radius:var(--r-sm);padding:9px 13px;font-size:.83rem;margin-top:4px;}
.exp-cards{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:26px;}
.exp-card{background:var(--card-bg);border-radius:var(--r);padding:26px;box-shadow:var(--shadow-sm);border:1px solid var(--border);transition:all var(--tr);}
.exp-card:hover{box-shadow:var(--shadow);}
.exp-icon{width:58px;height:58px;border-radius:14px;display:flex;align-items:center;justify-content:center;margin-bottom:14px;}
.exp-card h4{font-size:1rem;font-weight:600;color:var(--dark);margin-bottom:7px;}
.exp-card p{font-size:.86rem;color:var(--text-light);margin-bottom:18px;line-height:1.5;}

/* PREVIEW */
.prev-card{background:var(--card-bg);border:2px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow);transition:background var(--tr);}
.prev-hdr{display:flex;align-items:flex-start;justify-content:space-between;padding:24px 28px;border-bottom:2px solid var(--red);background:linear-gradient(135deg,#18100f 0%,#2c1210 100%);gap:14px;flex-wrap:wrap;}
.prev-logo{display:flex;align-items:center;gap:12px;}
.prev-inst{font-size:1.05rem;font-weight:700;color:#fff;}
.prev-tag{font-size:.73rem;color:rgba(255,255,255,.45);margin-top:2px;}
.prev-meta{text-align:right;color:#fff;font-size:.87rem;}
#previewTbl{padding:20px 24px;overflow-x:auto;}
.prev-foot{display:flex;gap:24px;padding:14px 28px;background:var(--bg);border-top:1px solid var(--border);font-size:.86rem;color:var(--text);flex-wrap:wrap;transition:background var(--tr);}

/* PDF PREVIEW MODAL */
.pdf-prev-body{padding:22px;max-height:70vh;overflow-y:auto;}
.pdf-prev-body .prev-card{box-shadow:none;border:1px solid var(--border);}

/* ============================================================
   MODALS
============================================================ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(5px);z-index:200;display:none;align-items:center;justify-content:center;padding:18px;}
.modal-overlay.active{display:flex;}
.modal{background:var(--card-bg);border-radius:18px;width:100%;max-width:490px;box-shadow:var(--shadow-lg);animation:modIn .22s cubic-bezier(.34,1.56,.64,1);transition:background var(--tr);}
.modal-wide{max-width:680px;}
.modal-setup{max-width:420px;padding:38px;}
@keyframes modIn{from{opacity:0;transform:scale(.92) translateY(14px);}to{opacity:1;transform:scale(1) translateY(0);}}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;padding:20px 22px 0;}
.modal-hdr h3{font-size:1.05rem;font-weight:700;color:var(--dark);}
.modal-close{background:var(--bg2);border:none;width:30px;height:30px;border-radius:50%;font-size:1.2rem;cursor:pointer;color:var(--text-light);transition:all var(--tr);display:flex;align-items:center;justify-content:center;}
.modal-close:hover{background:var(--red-light);color:var(--red);}
.modal-body{padding:20px 22px;display:flex;flex-direction:column;gap:15px;}
.modal-foot{display:flex;justify-content:flex-end;gap:9px;padding:0 22px 20px;}

/* CONFIRM MODAL */
.confirm-icon{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 14px;}
.confirm-icon-red{background:var(--red-light);}
.confirm-modal-body{padding:24px 28px;text-align:center;}
.confirm-title{font-size:1.1rem;font-weight:700;color:var(--dark);margin-bottom:8px;}
.confirm-msg{font-size:.9rem;color:var(--text-light);line-height:1.5;}
.confirm-foot{display:flex;justify-content:center;gap:10px;padding:0 28px 24px;}

/* ============================================================
   EMPTY
============================================================ */
.empty{text-align:center;padding:44px 22px;color:var(--text-light);font-size:.9rem;line-height:1.7;}

/* ============================================================
   TOAST
============================================================ */
.toast{position:fixed;bottom:26px;right:26px;background:var(--dark);color:var(--bg);padding:12px 20px;border-radius:11px;font-size:.86rem;font-weight:500;box-shadow:var(--shadow-lg);z-index:999;transform:translateY(90px);opacity:0;transition:all .28s cubic-bezier(.34,1.56,.64,1);max-width:300px;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-success{background:var(--success);color:#fff;}
.toast-error{background:var(--red);color:#fff;}

/* ============================================================
   MENTION COLORS
============================================================ */
.m-ajourne{color:#e74c3c;}
.m-passable{color:var(--warning);}
.m-assez-bien{color:var(--info);}
.m-bien{color:var(--success);}
.m-tres-bien{color:#8e44ad;}

/* ============================================================
   SETUP
============================================================ */
.setup-brand{text-align:center;margin-bottom:2rem;}

/* ============================================================
   RESPONSIVE
============================================================ */
@media(max-width:1100px){
  .stats-grid{grid-template-columns:1fr 1fr;}
  .analytics-grid{grid-template-columns:1fr;}
}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);}
  .sidebar.open{transform:translateX(0);}
  .sidebar-overlay{display:block;}
  .main{margin-left:0;}
  .sb-toggle{display:flex;}
  .view{padding:22px 16px 48px;}
  .topbar{padding:0 16px;}
  .stats-grid{grid-template-columns:1fr 1fr;gap:12px;}
  .stat-val{font-size:2.4rem;}
  .exp-cards{grid-template-columns:1fr;}
  .form-row3{grid-template-columns:1fr 1fr;}
  .view-hdr{flex-direction:column;align-items:flex-start;}
  .analytics-grid{grid-template-columns:1fr;}
  .mod-block-hdr{flex-wrap:wrap;}
  .tbl{min-width:400px;}
  .tbl th:nth-child(2),.tbl td:nth-child(2),.tbl th:nth-child(3),.tbl td:nth-child(3){display:none;}
}
@media(max-width:480px){
  .stats-grid{grid-template-columns:1fr;}
  .form-row3{grid-template-columns:1fr;}
  .tb-date{display:none;}
  .hist-grid{grid-template-columns:1fr;}
}

/* Mobile sidebar overlay */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;}
@media(max-width:768px){.sidebar-overlay.active{display:block;}}
</style>
</head>
<body>

<!-- SIDEBAR OVERLAY (mobile) -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sb-brand">
    <div class="sb-icon">
      <svg width="22" height="22" viewBox="0 0 28 28" fill="none">
        <path d="M14 4L22 9V14C22 18.4 19 22 14 24C9 22 6 18.4 6 14V9L14 4Z" fill="white" opacity=".95"/>
        <path d="M10 14L13 17L18 11" stroke="#c0392b" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div><span class="sb-name">CampusEdge</span><span class="sb-tag">Pro</span></div>
  </div>

  <nav class="sb-nav">
    <div class="nav-lbl">Principal</div>
    <a class="nav-item active" data-view="dashboard">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Tableau de bord
    </a>
    <a class="nav-item" data-view="modules">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
      Modules & Notes
    </a>
    <a class="nav-item" data-view="analytics">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Analytiques
    </a>
    <div class="nav-lbl" style="margin-top:1.4rem">Semestres</div>
    <a class="nav-item" data-view="history">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Historique
    </a>
    <div class="nav-lbl" style="margin-top:1.4rem">Actions</div>
    <a class="nav-item" data-view="export">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Exporter
    </a>
  </nav>

  <div class="sb-footer">
    <div class="stu-avatar" id="avInit">E</div>
    <div class="stu-details">
      <span class="stu-name" id="sbName">Etudiant</span>
      <span class="stu-sem" id="sbSem">Semestre 1</span>
    </div>
    <div class="sb-footer-btns">
      <button class="btn-sb-icon" onclick="openConfirm('Reinitialiser le semestre en cours ?','Toutes les notes et modules seront supprimes. Cette action est irreversible.','resetData')" title="Reinitialiser">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.31"/></svg>
      </button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <header class="topbar">
    <div class="topbar-l">
      <button class="sb-toggle" onclick="toggleSidebar()">
        <span></span><span></span><span></span>
      </button>
      <div class="tb-crumb" id="crumb">Tableau de bord</div>
    </div>
    <div class="topbar-r">
      <div class="tb-date" id="tbDate"></div>
      <button class="btn-theme" onclick="toggleTheme()" id="themeBtn" title="Mode sombre / clair">
        <svg id="themeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
      <div class="tb-stu" id="tbName">Etudiant</div>
    </div>
  </header>

  <!-- ===== DASHBOARD ===== -->
  <section class="view active" id="view-dashboard">
    <div class="view-hdr">
      <div>
        <h1 class="view-title">Bonjour, <span id="greetName">Etudiant</span></h1>
        <p class="view-sub">Apercu de vos performances academiques</p>
      </div>
      <button class="btn btn-primary" onclick="goTo('modules')">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Nouveau module
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card stat-main">
        <div style="position:relative;z-index:2">
          <div class="stat-lbl">Moyenne Generale</div>
          <div class="stat-val" id="statAvg">—</div>
          <div class="stat-mention" id="statMention">Aucune donnee</div>
          <div class="goal-bar-wrap" id="goalBarWrap" style="display:none">
            <div class="goal-bar-track"><div class="goal-bar-fill" id="goalBarFill"></div></div>
            <div class="goal-hint" id="goalHint"></div>
          </div>
        </div>
        <div class="stat-deco"></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon si-blue"><svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg></div>
        <div class="stat-lbl">Credits Totaux</div>
        <div class="stat-val stat-val-sm" id="statCred">0</div>
        <div class="stat-sub">ECTS</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon si-green"><svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg></div>
        <div class="stat-lbl">Modules</div>
        <div class="stat-val stat-val-sm" id="statMods">0</div>
        <div class="stat-sub">actifs</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon si-orange"><svg width="19" height="19" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div>
        <div class="stat-lbl">Matieres</div>
        <div class="stat-val stat-val-sm" id="statSubs">0</div>
        <div class="stat-sub">saisies</div>
      </div>
    </div>

    <!-- Objectif & Progression -->
    <div class="progression-card" id="progressionCard">
      <span class="prog-label">Objectif</span>
      <div class="goal-input-row">
        <label>Cible :</label>
        <input type="number" class="goal-input" id="goalInput" min="0" max="20" step="0.1" placeholder="Ex: 14" oninput="saveGoal()">
        <span style="font-size:.8rem;color:var(--text-light)">/20</span>
      </div>
      <div class="prog-track" id="progTrack" style="display:none">
        <div class="prog-fill" id="progFill"></div>
      </div>
      <div class="prog-text" id="progText"></div>
    </div>

    <div class="sec-title-row"><h2 class="sec-title">Apercu par Module</h2></div>
    <div class="mod-overview" id="dashOverview">
      <div class="empty"><p>Aucun module ajoute. Demarrez dans l'onglet <strong>Modules & Notes</strong>.</p></div>
    </div>
  </section>

  <!-- ===== MODULES ===== -->
  <section class="view" id="view-modules">
    <div class="view-hdr">
      <div>
        <h1 class="view-title">Modules & Notes</h1>
        <p class="view-sub">Gerez vos modules — glissez pour reordonner</p>
      </div>
      <button class="btn btn-primary" onclick="openModModal()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Nouveau Module
      </button>
    </div>
    <div class="mods-list" id="modsList">
      <div class="empty"><p>Aucun module. Cliquez sur <strong>Nouveau Module</strong>.</p></div>
    </div>
  </section>

  <!-- ===== ANALYTICS ===== -->
  <section class="view" id="view-analytics">
    <div class="view-hdr">
      <div>
        <h1 class="view-title">Analytiques</h1>
        <p class="view-sub">Visualisez vos performances academiques</p>
      </div>
    </div>
    <div class="analytics-grid">
      <div class="chart-card">
        <div class="chart-hdr">
          <h3>Moyennes par Module</h3>
          <div class="legend"><span class="legend-dot" style="background:#c0392b"></span>Moyenne</div>
        </div>
        <div class="chart-wrap"><canvas id="chartBar"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-hdr"><h3>Repartition des Credits</h3></div>
        <div class="chart-wrap"><canvas id="chartDough"></canvas></div>
      </div>
    </div>
    <div class="tbl-card">
      <div class="chart-hdr" style="margin-bottom:16px"><h3>Recapitulatif Detaille</h3></div>
      <div class="tbl-wrap" id="anaTable"><div class="empty">Aucune donnee disponible.</div></div>
    </div>
  </section>

  <!-- ===== HISTORIQUE ===== -->
  <section class="view" id="view-history">
    <div class="view-hdr">
      <div>
        <h1 class="view-title">Historique des Semestres</h1>
        <p class="view-sub">Archivez et consultez vos semestres passes</p>
      </div>
    </div>
    <div class="archive-banner">
      <div class="archive-banner-text">
        <strong>Semestre actuel :</strong> <span id="archCurrentSem">—</span>
        &nbsp;·&nbsp; <span id="archCurrentMods">0 module(s)</span>
        &nbsp;·&nbsp; Moy. <span id="archCurrentAvg">—</span>
      </div>
      <button class="btn btn-primary btn-sm" onclick="openArchiveModal()">
        Archiver ce semestre
      </button>
    </div>
    <div class="hist-grid" id="histGrid">
      <div class="empty" style="grid-column:1/-1">Aucun semestre archive.</div>
    </div>
  </section>

  <!-- ===== EXPORT ===== -->
  <section class="view" id="view-export">
    <div class="view-hdr">
      <div>
        <h1 class="view-title">Exporter</h1>
        <p class="view-sub">Generez vos releves de notes officiels</p>
      </div>
    </div>
    <div class="exp-profile">
      <h3>Informations etudiant</h3>
      <div class="form-row">
        <div class="fg"><label>Nom complet</label><input class="fi" id="eName" placeholder="Ex: Marie Dubois" oninput="saveProfile()"></div>
        <div class="fg"><label>Filiere</label><input class="fi" id="eProg" placeholder="Ex: Master Finance" oninput="saveProfile()"></div>
        <div class="fg"><label>Semestre</label><input class="fi" id="eSem" placeholder="Ex: Semestre 2 — 2024/2025" oninput="saveProfile()"></div>
        <div class="fg"><label>Etablissement</label><input class="fi" id="eInst" placeholder="Ex: Ecole Superieure de Commerce" oninput="saveProfile()"></div>
      </div>
    </div>
    <div class="exp-cards">
      <div class="exp-card">
        <div class="exp-icon" style="background:var(--red-light);color:var(--red)">
          <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        </div>
        <h4>Releve PDF</h4>
        <p>Generez un releve de notes officiel au format PDF, pret a etre imprime ou partage.</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" onclick="openPDFPreview()">Apercu</button>
          <button class="btn btn-primary btn-sm" onclick="exportPDF()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Telecharger PDF
          </button>
        </div>
      </div>
      <div class="exp-card">
        <div class="exp-icon" style="background:#f0fff4;color:var(--success)">
          <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        </div>
        <h4>Export CSV</h4>
        <p>Telechargez toutes vos donnees sous format CSV exploitable directement dans Excel.</p>
        <button class="btn btn-secondary btn-sm" onclick="exportCSV()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Exporter en CSV
        </button>
      </div>
    </div>
    <!-- PREVIEW -->
    <div class="prev-card">
      <div class="prev-hdr">
        <div class="prev-logo">
          <svg width="30" height="30" viewBox="0 0 28 28" fill="none"><rect width="28" height="28" rx="8" fill="rgba(255,255,255,.12)"/><path d="M14 5L21 9.5V14C21 18 18.5 21 14 23C9.5 21 7 18 7 14V9.5L14 5Z" fill="white" opacity=".9"/><path d="M11 14L13 16L17 12" stroke="#c0392b" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <div><div class="prev-inst" id="prevInst">Votre Etablissement</div><div class="prev-tag">Releve de Notes — Document Officiel</div></div>
        </div>
        <div class="prev-meta">
          <div><strong id="prevName">Nom etudiant</strong></div>
          <div id="prevProg" style="color:rgba(255,255,255,.5);font-size:.82rem"></div>
          <div id="prevSem" style="color:rgba(255,255,255,.5);font-size:.82rem"></div>
        </div>
      </div>
      <div id="previewTbl"></div>
      <div class="prev-foot">
        <div>Moyenne Generale : <strong id="prevAvg">—</strong></div>
        <div>Credits : <strong id="prevCred">—</strong></div>
        <div>Mention : <strong id="prevMent">—</strong></div>
      </div>
    </div>
  </section>
</main>

<!-- ===== MODAL: ADD / EDIT MODULE ===== -->
<div class="modal-overlay" id="mMod">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-hdr">
      <h3 id="mModTitle">Nouveau Module</h3>
      <button class="modal-close" onclick="closeModal('mMod')">×</button>
    </div>
    <div class="modal-body">
      <div class="fg"><label>Nom du module</label><input class="fi" id="modName" placeholder="Ex: Module Scientifique" onkeydown="if(event.key==='Enter')saveModule()"></div>
      <div class="ferr" id="modErr" style="display:none"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mMod')">Annuler</button>
      <button class="btn btn-primary" id="mModBtn" onclick="saveModule()">Creer</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: ADD / EDIT SUBJECT ===== -->
<div class="modal-overlay" id="mSub">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-hdr">
      <h3 id="mSubTitle">Ajouter une Matiere</h3>
      <button class="modal-close" onclick="closeModal('mSub')">×</button>
    </div>
    <div class="modal-body">
      <div class="fg"><label>Nom de la matiere</label><input class="fi" id="subName" placeholder="Ex: Mathematiques"></div>
      <div class="form-row3">
        <div class="fg">
          <label>Note CC <span class="lhint">/20</span></label>
          <div class="fi-wrap">
            <input type="number" class="fi" id="subCC" placeholder="0–20" min="0" max="20" step="0.01" oninput="validateGrade(this)">
          </div>
          <div class="cell-hint" id="minExamHint" style="color:var(--info);display:none"></div>
        </div>
        <div class="fg">
          <label>Note Examen <span class="lhint">/20</span></label>
          <div class="fi-wrap">
            <input type="number" class="fi" id="subExam" placeholder="0–20" min="0" max="20" step="0.01" oninput="validateGrade(this);updateMinExamHint()">
          </div>
        </div>
        <div class="fg"><label>Credits <span class="lhint">ECTS</span></label><input type="number" class="fi" id="subCred" placeholder="Ex: 3" min="1" step="1" onkeydown="if(event.key==='Enter')saveSubject()"></div>
      </div>
      <div class="ferr" id="subErr" style="display:none"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mSub')">Annuler</button>
      <button class="btn btn-primary" id="mSubBtn" onclick="saveSubject()">Ajouter</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: CONFIRM ===== -->
<div class="modal-overlay" id="mConfirm">
  <div class="modal" style="max-width:380px" onclick="event.stopPropagation()">
    <div class="confirm-modal-body">
      <div class="confirm-icon confirm-icon-red">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
      </div>
      <div class="confirm-title" id="confirmTitle">Confirmer</div>
      <div class="confirm-msg" id="confirmMsg"></div>
    </div>
    <div class="confirm-foot">
      <button class="btn btn-ghost" onclick="closeModal('mConfirm')">Annuler</button>
      <button class="btn btn-primary" id="confirmBtn" style="background:var(--red)">Supprimer</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: ARCHIVE ===== -->
<div class="modal-overlay" id="mArchive">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-hdr">
      <h3>Archiver ce Semestre</h3>
      <button class="modal-close" onclick="closeModal('mArchive')">×</button>
    </div>
    <div class="modal-body">
      <p style="font-size:.9rem;color:var(--text-light);line-height:1.6">Le semestre actuel sera sauvegarde dans l'historique. Un nouveau semestre vide commencera.</p>
      <div class="fg"><label>Nom du semestre</label><input class="fi" id="archiveName" placeholder="Ex: Semestre 1 — 2024/2025"></div>
      <div class="ferr" id="archErr" style="display:none"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mArchive')">Annuler</button>
      <button class="btn btn-primary" onclick="archiveSemester()">Archiver et nouveau semestre</button>
    </div>
  </div>
</div>

<!-- ===== MODAL: PDF PREVIEW ===== -->
<div class="modal-overlay" id="mPDFPreview">
  <div class="modal modal-wide" onclick="event.stopPropagation()">
    <div class="modal-hdr">
      <h3>Apercu du Releve PDF</h3>
      <button class="modal-close" onclick="closeModal('mPDFPreview')">×</button>
    </div>
    <div class="pdf-prev-body" id="pdfPreviewBody"></div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('mPDFPreview')">Fermer</button>
      <button class="btn btn-primary" onclick="exportPDF();closeModal('mPDFPreview')">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Telecharger PDF
      </button>
    </div>
  </div>
</div>

<!-- SETUP -->
<div class="modal-overlay active" id="mSetup">
  <div class="modal modal-setup" onclick="event.stopPropagation()">
    <div class="setup-brand">
      <div style="width:54px;height:54px;border-radius:14px;background:var(--red);display:flex;align-items:center;justify-content:center;margin:0 auto 14px">
        <svg width="30" height="30" viewBox="0 0 28 28" fill="none"><path d="M14 4L22 9V14C22 18.4 19 22 14 24C9 22 6 18.4 6 14V9L14 4Z" fill="white" opacity=".95"/><path d="M10 14L13 17L18 11" stroke="#c0392b" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <h2 style="font-family:'DM Serif Display',serif;font-size:1.75rem;color:var(--dark);margin:0 0 .25rem">CampusEdge Pro</h2>
      <p style="color:var(--text-light);font-size:.9rem;margin:0 0 1.8rem">Configurez votre profil pour commencer</p>
    </div>
    <div class="fg" style="margin-bottom:14px"><label>Votre prenom</label><input class="fi fi-lg" id="setupName" placeholder="Ex: Marie" onkeydown="if(event.key==='Enter')setupProfile()"></div>
    <div class="fg"><label>Semestre en cours</label><input class="fi" id="setupSem" placeholder="Ex: Semestre 1 — 2024/2025"></div>
    <button class="btn btn-primary btn-full" style="margin-top:1.4rem" onclick="setupProfile()">
      Commencer mon Dashboard
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
    </button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ============================================================
   STATE
============================================================ */
let S = {
  profile: { name:'', semester:'', program:'', institution:'' },
  modules: [],     // { id, name, subjects:[{id,name,cc,exam,credits}] }
  history: [],     // { id, name, date, modules, profile }
  goal: null,
  theme: 'light'
};

// Edit context
let editModId = null;   // null = new, string = editing
let editSubId = null;
let editSubModId = null;
let targetMod = null;   // for new subject
let confirmCallback = null;

let chartBar = null, chartDough = null;

/* ============================================================
   INIT
============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  load();
  applyTheme();
  g('tbDate').textContent = new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

  if (!S.profile.name) {
    g('mSetup').classList.add('active');
  } else {
    applyProfile();
    renderAll();
    goTo('dashboard');
  }

  // Restore goal input
  if (S.goal) g('goalInput').value = S.goal;

  // Nav items
  document.querySelectorAll('.nav-item').forEach(el => {
    el.addEventListener('click', e => {
      e.preventDefault();
      goTo(el.dataset.view);
      closeSidebar();
    });
  });

  // Delegation: modsList
  g('modsList').addEventListener('click', e => {
    const dMod = e.target.closest('.js-del-mod');
    const eMod = e.target.closest('.js-edit-mod');
    const dSub = e.target.closest('.js-del-sub');
    const eSub = e.target.closest('.js-edit-sub');
    const addSub = e.target.closest('.js-add-sub');
    if (dMod) openConfirm('Supprimer ce module ?','Toutes les matieres associees seront egalement supprimees.','deleteMod:'+dMod.dataset.mod);
    else if (eMod) openEditModModal(eMod.dataset.mod);
    else if (dSub) openConfirm('Supprimer cette matiere ?','Cette note sera definitivement supprimee.','deleteSub:'+dSub.dataset.mod+':'+dSub.dataset.sub);
    else if (eSub) openEditSubModal(eSub.dataset.mod, eSub.dataset.sub);
    else if (addSub) openAddSubModal(addSub.dataset.mod);
  });

  // Drag and drop
  initDragDrop();

  // CC input → update min exam hint
  g('subCC').addEventListener('input', updateMinExamHint);
});

/* ============================================================
   PERSISTENCE
============================================================ */
function save() { localStorage.setItem('ce_v2', JSON.stringify(S)); }
function load() {
  try {
    const r = localStorage.getItem('ce_v2');
    if (r) S = { ...S, ...JSON.parse(r) };
  } catch(e) {}
}

/* ============================================================
   THEME
============================================================ */
function toggleTheme() {
  S.theme = S.theme === 'light' ? 'dark' : 'light';
  save();
  applyTheme();
}
function applyTheme() {
  document.documentElement.setAttribute('data-theme', S.theme || 'light');
  const icon = g('themeIcon');
  if (S.theme === 'dark') {
    icon.innerHTML = '<circle cx="12" cy="12" r="5"/><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
  } else {
    icon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
  }
  if (chartBar || chartDough) renderCharts();
}

/* ============================================================
   PROFILE
============================================================ */
function setupProfile() {
  const n = g('setupName').value.trim();
  if (!n) { g('setupName').focus(); return; }
  S.profile.name = n;
  S.profile.semester = g('setupSem').value.trim() || 'Semestre 1';
  save(); applyProfile();
  g('mSetup').classList.remove('active');
  renderAll(); goTo('dashboard');
  toast('Bienvenue, ' + n + ' !', 'success');
}

function applyProfile() {
  const p = S.profile, d = p.name || 'Etudiant';
  setT('greetName', d); setT('sbName', d);
  setT('sbSem', p.semester || '');
  setT('tbName', d);
  setT('avInit', d[0].toUpperCase());
  sv('eName', p.name||''); sv('eProg', p.program||'');
  sv('eSem', p.semester||''); sv('eInst', p.institution||'');
  updatePreview();
}

function saveProfile() {
  S.profile.name = gv('eName');
  S.profile.program = gv('eProg');
  S.profile.semester = gv('eSem');
  S.profile.institution = gv('eInst');
  save(); applyProfile();
}

/* ============================================================
   RESET
============================================================ */
function resetData() {
  S.modules = []; S.goal = null;
  sv('goalInput', '');
  save(); renderAll();
  toast('Semestre reinitialise');
}

/* ============================================================
   CALCULATIONS
============================================================ */
function calcFinal(cc, exam) { return cc * 0.4 + exam * 0.6; }
function calcModAvg(subjects) {
  if (!subjects || !subjects.length) return null;
  let sw = 0, sc = 0;
  for (const s of subjects) { sw += calcFinal(s.cc, s.exam) * s.credits; sc += s.credits; }
  return sc > 0 ? sw / sc : null;
}
function calcGenAvg() {
  let sw = 0, sc = 0;
  for (const m of S.modules) for (const s of m.subjects) { sw += calcFinal(s.cc, s.exam) * s.credits; sc += s.credits; }
  return sc > 0 ? sw / sc : null;
}
function totalCred() { return S.modules.reduce((a,m) => a + m.subjects.reduce((b,s) => b + s.credits, 0), 0); }
function totalSubs() { return S.modules.reduce((a,m) => a + m.subjects.length, 0); }
function mention(avg) {
  if (avg === null) return { l:'Aucune donnee', c:'' };
  if (avg < 10) return { l:'Ajourne', c:'m-ajourne' };
  if (avg < 12) return { l:'Passable', c:'m-passable' };
  if (avg < 14) return { l:'Assez Bien', c:'m-assez-bien' };
  if (avg < 16) return { l:'Bien', c:'m-bien' };
  return { l:'Tres Bien', c:'m-tres-bien' };
}
function nextMentionThreshold(avg) {
  if (avg === null) return null;
  const thresholds = [10, 12, 14, 16, 20];
  return thresholds.find(t => t > avg) || null;
}
function fmt(n, d=2) { if (n === null || isNaN(n)) return '—'; return n.toFixed(d); }
function gc(g) { if (g === null) return ''; if (g < 10) return 'gb-bad'; if (g >= 14) return 'gb-good'; return ''; }

// Min exam to pass (final >= 10): exam = (10 - cc*0.4) / 0.6
function minExamToPass(cc) {
  if (cc === null || isNaN(cc)) return null;
  const min = (10 - cc * 0.4) / 0.6;
  if (min <= 0) return 0;
  if (min > 20) return null; // impossible
  return min;
}

/* ============================================================
   GOAL / OBJECTIF
============================================================ */
function saveGoal() {
  const v = parseFloat(g('goalInput').value);
  S.goal = (!isNaN(v) && v >= 0 && v <= 20) ? v : null;
  save();
  renderStats();
}

/* ============================================================
   NAVIGATION
============================================================ */
function goTo(v) {
  document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
  g('view-' + v)?.classList.add('active');
  document.querySelector('.nav-item[data-view="' + v + '"]')?.classList.add('active');
  const labels = { dashboard:'Tableau de bord', modules:'Modules & Notes', analytics:'Analytiques', history:'Historique', export:'Exporter' };
  setT('crumb', labels[v] || '');
  if (v === 'analytics') renderCharts();
  if (v === 'export') { updatePreview(); }
  if (v === 'history') renderHistory();
}

function toggleSidebar() {
  g('sidebar').classList.toggle('open');
  g('sidebarOverlay').classList.toggle('active');
}
function closeSidebar() {
  g('sidebar').classList.remove('open');
  g('sidebarOverlay').classList.remove('active');
}

/* ============================================================
   CONFIRM MODAL
============================================================ */
function openConfirm(title, msg, action) {
  setT('confirmTitle', title);
  setT('confirmMsg', msg);
  confirmCallback = action;
  g('confirmBtn').onclick = () => { executeConfirm(); closeModal('mConfirm'); };
  openModal('mConfirm');
}

function executeConfirm() {
  if (!confirmCallback) return;
  const [action, ...args] = confirmCallback.split(':');
  if (action === 'resetData') resetData();
  else if (action === 'deleteMod') deleteMod(args[0]);
  else if (action === 'deleteSub') deleteSub(args[0], args[1]);
  else if (action === 'deleteHistory') deleteHistory(args[0]);
  confirmCallback = null;
}

/* ============================================================
   MODULES
============================================================ */
function openModModal() {
  editModId = null;
  sv('modName', '');
  g('modErr').style.display = 'none';
  setT('mModTitle', 'Nouveau Module');
  setT('mModBtn', 'Creer');
  openModal('mMod');
  setTimeout(() => g('modName').focus(), 80);
}

function openEditModModal(id) {
  const m = S.modules.find(x => x.id === id);
  if (!m) return;
  editModId = id;
  sv('modName', m.name);
  g('modErr').style.display = 'none';
  setT('mModTitle', 'Modifier le Module');
  setT('mModBtn', 'Enregistrer');
  openModal('mMod');
  setTimeout(() => g('modName').focus(), 80);
}

function saveModule() {
  const name = g('modName').value.trim();
  if (!name) { showErr('modErr', 'Veuillez saisir un nom.'); return; }
  if (editModId) {
    const m = S.modules.find(x => x.id === editModId);
    if (m) m.name = name;
    toast('Module modifie', 'success');
  } else {
    S.modules.push({ id: uid(), name, subjects: [] });
    toast('Module "' + name + '" cree', 'success');
  }
  editModId = null;
  save(); renderAll(); closeModal('mMod');
}

function deleteMod(id) {
  S.modules = S.modules.filter(m => m.id !== id);
  save(); renderAll(); toast('Module supprime');
}

/* ============================================================
   SUBJECTS
============================================================ */
function openAddSubModal(modId) {
  targetMod = modId; editSubId = null; editSubModId = null;
  ['subName','subCC','subExam','subCred'].forEach(id => { sv(id,''); g(id).classList.remove('valid','invalid'); });
  g('subErr').style.display = 'none';
  g('minExamHint').style.display = 'none';
  setT('mSubTitle', 'Ajouter une Matiere');
  setT('mSubBtn', 'Ajouter');
  openModal('mSub');
  setTimeout(() => g('subName').focus(), 80);
}

function openEditSubModal(modId, subId) {
  const m = S.modules.find(x => x.id === modId);
  if (!m) return;
  const s = m.subjects.find(x => x.id === subId);
  if (!s) return;
  editSubModId = modId; editSubId = subId;
  sv('subName', s.name);
  sv('subCC', s.cc);
  sv('subExam', s.exam);
  sv('subCred', s.credits);
  ['subCC','subExam'].forEach(id => validateGrade(g(id)));
  g('subErr').style.display = 'none';
  setT('mSubTitle', 'Modifier la Matiere');
  setT('mSubBtn', 'Enregistrer');
  openModal('mSub');
  updateMinExamHint();
  setTimeout(() => g('subName').focus(), 80);
}

function saveSubject() {
  const name = g('subName').value.trim();
  const cc = parseFloat(g('subCC').value);
  const exam = parseFloat(g('subExam').value);
  const credits = parseFloat(g('subCred').value);
  if (!name) return showErr('subErr', 'Veuillez saisir un nom de matiere.');
  if (isNaN(cc) || cc < 0 || cc > 20) return showErr('subErr', 'Note CC invalide (0–20).');
  if (isNaN(exam) || exam < 0 || exam > 20) return showErr('subErr', 'Note Examen invalide (0–20).');
  if (isNaN(credits) || credits <= 0) return showErr('subErr', 'Les credits doivent etre > 0.');

  if (editSubId) {
    const m = S.modules.find(x => x.id === editSubModId);
    if (m) {
      const s = m.subjects.find(x => x.id === editSubId);
      if (s) { s.name = name; s.cc = cc; s.exam = exam; s.credits = credits; }
    }
    toast('Matiere modifiee', 'success');
  } else {
    const m = S.modules.find(x => x.id === targetMod);
    if (!m) return;
    m.subjects.push({ id: uid(), name, cc, exam, credits });
    toast('"' + name + '" ajoutee', 'success');
  }
  editSubId = null; editSubModId = null;
  save(); renderAll(); closeModal('mSub');
}

function deleteSub(modId, subId) {
  const m = S.modules.find(x => x.id === modId);
  if (m) m.subjects = m.subjects.filter(s => s.id !== subId);
  save(); renderAll();
}

/* ============================================================
   VALIDATION EN TEMPS REEL
============================================================ */
function validateGrade(input) {
  const v = parseFloat(input.value);
  input.classList.remove('valid', 'invalid');
  if (input.value === '') return;
  if (isNaN(v) || v < 0 || v > 20) input.classList.add('invalid');
  else input.classList.add('valid');
}

function updateMinExamHint() {
  const cc = parseFloat(g('subCC').value);
  const hintEl = g('minExamHint');
  if (isNaN(cc) || cc < 0 || cc > 20) { hintEl.style.display = 'none'; return; }
  const minExam = minExamToPass(cc);
  if (minExam === null) {
    hintEl.textContent = 'Validation impossible meme avec 20/20 a l\'examen';
    hintEl.style.color = 'var(--red)';
  } else if (minExam === 0) {
    hintEl.textContent = 'Matiere validee quel que soit la note d\'examen';
    hintEl.style.color = 'var(--success)';
  } else {
    hintEl.textContent = 'Note min. a l\'examen pour valider : ' + fmt(minExam) + '/20';
    hintEl.style.color = 'var(--info)';
  }
  hintEl.style.display = 'block';
}

/* ============================================================
   DRAG & DROP
============================================================ */
let dragSrcId = null;
function initDragDrop() {
  // Re-called after each render via renderMods
}
function attachDragListeners() {
  document.querySelectorAll('.mod-block[draggable]').forEach(el => {
    el.addEventListener('dragstart', e => {
      dragSrcId = el.dataset.modid;
      el.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    el.addEventListener('dragend', () => el.classList.remove('dragging','drag-over'));
    el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('drag-over'); });
    el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
    el.addEventListener('drop', e => {
      e.preventDefault();
      el.classList.remove('drag-over');
      const overModId = el.dataset.modid;
      if (!dragSrcId || dragSrcId === overModId) return;
      const srcIdx = S.modules.findIndex(m => m.id === dragSrcId);
      const overIdx = S.modules.findIndex(m => m.id === overModId);
      if (srcIdx < 0 || overIdx < 0) return;
      const [moved] = S.modules.splice(srcIdx, 1);
      S.modules.splice(overIdx, 0, moved);
      dragSrcId = null;
      save(); renderMods(); renderDash();
    });
  });
}

/* ============================================================
   RENDER ALL
============================================================ */
function renderAll() {
  renderStats();
  renderDash();
  renderMods();
  renderAnaTable();
  updatePreview();
  renderHistoryBanner();
}

/* STATS */
function renderStats() {
  const avg = calcGenAvg(), men = mention(avg);
  const el = g('statAvg');
  el.textContent = avg !== null ? fmt(avg) : '—';
  el.style.fontSize = avg !== null ? '3rem' : '2rem';
  const mel = g('statMention'); mel.textContent = men.l; mel.className = 'stat-mention ' + men.c;
  setT('statCred', totalCred()); setT('statMods', S.modules.length); setT('statSubs', totalSubs());

  // Goal bar
  const goal = S.goal;
  const goalWrap = g('goalBarWrap');
  if (goal && avg !== null) {
    goalWrap.style.display = 'block';
    const pct = Math.min(100, (avg / goal) * 100);
    g('goalBarFill').style.width = pct + '%';
    const diff = goal - avg;
    if (diff <= 0) g('goalHint').textContent = 'Objectif atteint ! (' + fmt(avg) + '/' + fmt(goal) + ')';
    else g('goalHint').textContent = 'Il vous manque ' + fmt(diff) + ' points pour atteindre ' + fmt(goal);
  } else {
    goalWrap.style.display = 'none';
  }

  // Progression toward next mention
  const progTrack = g('progTrack'), progText = g('progText');
  if (avg !== null) {
    const next = nextMentionThreshold(avg);
    if (next && next < 20) {
      const diff = next - avg;
      const prev = [0,10,12,14,16].filter(t => t <= avg).pop() || 0;
      const range = next - prev;
      const pct = Math.min(100, ((avg - prev) / range) * 100);
      const nextMen = mention(next + 0.01);
      progTrack.style.display = 'block';
      g('progFill').style.width = pct + '%';
      g('progFill').style.background = 'var(--red)';
      progText.textContent = 'Encore ' + fmt(diff) + ' pts pour ' + nextMen.l;
    } else if (avg >= 16) {
      progTrack.style.display = 'none';
      progText.textContent = 'Mention Tres Bien — Felicitations !';
    }
  } else {
    progTrack.style.display = 'none';
    progText.textContent = '';
  }
}

/* DASHBOARD OVERVIEW */
function renderDash() {
  const c = g('dashOverview');
  if (!S.modules.length) { c.innerHTML = '<div class="empty"><p>Aucun module ajoute. Demarrez dans l\'onglet <strong>Modules & Notes</strong>.</p></div>'; return; }
  c.innerHTML = S.modules.map(m => {
    const avg = calcModAvg(m.subjects), men = mention(avg);
    const cred = m.subjects.reduce((a,s) => a+s.credits, 0);
    const pct = avg !== null ? Math.min(100, (avg/20)*100) : 0;
    return `<div class="mod-ov-card">
      <div class="mod-ov-name">${esc(m.name)}</div>
      <div class="mod-ov-avg ${men.c}">${avg!==null?fmt(avg):'—'}</div>
      <div class="mod-ov-meta">${m.subjects.length} matiere(s) &middot; ${cred} credit(s) &middot; ${men.l}</div>
      <div class="mod-ov-bar"><div class="mod-ov-fill" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');
}

/* MODULES LIST */
function renderMods() {
  const c = g('modsList');
  if (!S.modules.length) { c.innerHTML = '<div class="empty"><p>Aucun module. Cliquez sur <strong>Nouveau Module</strong>.</p></div>'; return; }
  c.innerHTML = S.modules.map(m => renderModBlock(m)).join('');
  attachDragListeners();
}

function renderModBlock(m) {
  const avg = calcModAvg(m.subjects);
  const cred = m.subjects.reduce((a,s) => a+s.credits, 0);
  const badge = avg!==null ? 'Moy: '+fmt(avg)+'/20 &middot; '+cred+' cred.' : cred+' credit(s)';
  const rows = m.subjects.map(s => {
    const f = calcFinal(s.cc, s.exam);
    return `<tr>
      <td class="cell-name">${esc(s.name)}</td>
      <td><span class="gb ${gc(s.cc)}">${fmt(s.cc)}</span></td>
      <td><span class="gb ${gc(s.exam)}">${fmt(s.exam)}</span></td>
      <td><span class="gb gb-final ${gc(f)}">${fmt(f)}</span></td>
      <td><span class="cred-pill">${s.credits} ECTS</span></td>
      <td style="white-space:nowrap">
        <button class="btn-edit-ghost js-edit-sub" data-mod="${m.id}" data-sub="${s.id}" title="Modifier">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn-danger-ghost js-del-sub" data-mod="${m.id}" data-sub="${s.id}" title="Supprimer">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </button>
      </td>
    </tr>`;
  }).join('');
  const empty = !m.subjects.length ? `<tr><td colspan="6" class="empty" style="padding:22px;font-size:.85rem;">Aucune matiere dans ce module.</td></tr>` : '';

  return `<div class="mod-block" draggable="true" data-modid="${m.id}">
    <div class="mod-block-hdr">
      <div class="mod-block-title">
        <div class="drag-handle" title="Glisser pour reordonner">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1" fill="currentColor"/><circle cx="9" cy="12" r="1" fill="currentColor"/><circle cx="9" cy="19" r="1" fill="currentColor"/><circle cx="15" cy="5" r="1" fill="currentColor"/><circle cx="15" cy="12" r="1" fill="currentColor"/><circle cx="15" cy="19" r="1" fill="currentColor"/></svg>
        </div>
        <div class="mod-dot"></div>
        <div class="mod-name">${esc(m.name)}</div>
      </div>
      <div class="mod-block-actions">
        <span class="mod-avg-badge">${badge}</span>
        <button class="btn-edit-ghost js-edit-mod" data-mod="${m.id}" title="Modifier le module">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="btn-danger-ghost js-del-mod" data-mod="${m.id}" title="Supprimer le module">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </button>
      </div>
    </div>
    <div class="tbl-wrap">
      <table class="tbl">
        <thead><tr><th>Matiere</th><th>CC /20</th><th>Exam /20</th><th>Finale</th><th>Credits</th><th></th></tr></thead>
        <tbody>${rows}${empty}</tbody>
      </table>
    </div>
    <div class="mod-add-row">
      <button class="btn-add-sub js-add-sub" data-mod="${m.id}">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Ajouter une matiere
      </button>
    </div>
  </div>`;
}

/* ANALYTICS TABLE */
function renderAnaTable() {
  const c = g('anaTable');
  if (!S.modules.length || !totalSubs()) { c.innerHTML='<div class="empty">Aucune donnee disponible.</div>'; return; }
  let h = `<table class="tbl"><thead><tr><th>Module</th><th>Matiere</th><th>CC</th><th>Exam</th><th>Finale</th><th>Credits</th><th>Moy.</th></tr></thead><tbody>`;
  for (const m of S.modules) {
    const ma = calcModAvg(m.subjects), mc = m.subjects.reduce((a,s)=>a+s.credits,0);
    if (!m.subjects.length) { h+=`<tr><td style="font-weight:600">${esc(m.name)}</td><td colspan="5" style="color:var(--text-light);font-style:italic">Aucune matiere</td><td>—</td></tr>`; continue; }
    m.subjects.forEach((s,i) => {
      const f = calcFinal(s.cc, s.exam);
      h += `<tr>
        ${i===0?`<td rowspan="${m.subjects.length}" style="font-weight:600;vertical-align:top;padding-top:13px">${esc(m.name)}<br><span style="font-size:.75rem;color:var(--text-light);font-weight:400">${mc} cred.</span></td>`:''}
        <td class="cell-name">${esc(s.name)}</td>
        <td><span class="gb">${fmt(s.cc)}</span></td>
        <td><span class="gb">${fmt(s.exam)}</span></td>
        <td><span class="gb gb-final ${gc(f)}">${fmt(f)}</span></td>
        <td><span class="cred-pill">${s.credits}</span></td>
        ${i===0?`<td rowspan="${m.subjects.length}" style="vertical-align:middle;font-family:'DM Serif Display',serif;font-size:1.35rem;color:var(--red);text-align:center">${fmt(ma)}</td>`:''}
      </tr>`;
    });
  }
  h += '</tbody></table>';
  c.innerHTML = h;
}

/* ============================================================
   CHARTS
============================================================ */
function renderCharts() {
  const mods = S.modules.filter(m => m.subjects.length > 0);
  const labels = mods.map(m => m.name);
  const avgs = mods.map(m => { const a=calcModAvg(m.subjects); return a!==null?parseFloat(a.toFixed(2)):0; });
  const creds = mods.map(m => m.subjects.reduce((a,s)=>a+s.credits,0));
  const isDark = S.theme === 'dark';
  const gridColor = isDark ? 'rgba(255,255,255,.06)' : '#f0ebe8';
  const tickColor = isDark ? '#7a6a64' : '#9c8c87';
  const palette = ['#c0392b','#e74c3c','#f1948a','#fadbd8','#96281b','#7b1f14','#d98880'];

  if (chartBar) chartBar.destroy();
  chartBar = new Chart(g('chartBar'), {
    type: 'bar',
    data: { labels, datasets: [{ label:'Moyenne', data:avgs, backgroundColor:labels.map((_,i)=>`rgba(192,57,43,${0.55+(i%4)*.12})`), borderColor:'#c0392b', borderWidth:1.5, borderRadius:6, borderSkipped:false }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y.toFixed(2)}/20`}} }, scales:{ y:{min:0,max:20,grid:{color:gridColor},ticks:{font:{family:'DM Sans'},color:tickColor}}, x:{grid:{display:false},ticks:{font:{family:'DM Sans'},color:tickColor}} } }
  });

  if (chartDough) chartDough.destroy();
  chartDough = new Chart(g('chartDough'), {
    type: 'doughnut',
    data: { labels, datasets: [{ data:creds, backgroundColor:palette.slice(0,labels.length), borderColor:isDark?'#18100f':'#fff', borderWidth:3 }] },
    options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{ legend:{position:'bottom',labels:{font:{family:'DM Sans',size:11},color:isDark?'#d4c5be':'#3a2e2b',padding:14,usePointStyle:true}}, tooltip:{callbacks:{label:ctx=>` ${ctx.label}: ${ctx.parsed} credits`}} } }
  });
}

/* ============================================================
   HISTORIQUE
============================================================ */
function openArchiveModal() {
  sv('archiveName', S.profile.semester || '');
  g('archErr').style.display = 'none';
  openModal('mArchive');
  setTimeout(() => g('archiveName').focus(), 80);
}

function archiveSemester() {
  const name = g('archiveName').value.trim();
  if (!name) { showErr('archErr','Veuillez saisir un nom pour ce semestre.'); return; }
  const snap = {
    id: uid(),
    name,
    date: new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'}),
    modules: JSON.parse(JSON.stringify(S.modules)),
    profile: { ...S.profile },
    avg: calcGenAvg(),
    credits: totalCred()
  };
  S.history.unshift(snap);
  S.modules = [];
  if (g('archiveName').value) S.profile.semester = '';
  save(); renderAll(); renderHistory();
  closeModal('mArchive');
  toast('Semestre archive. Nouveau semestre demarre.', 'success');
  goTo('history');
}

function deleteHistory(id) {
  S.history = S.history.filter(h => h.id !== id);
  save(); renderHistory();
  toast('Semestre supprime');
}

function renderHistory() {
  renderHistoryBanner();
  const c = g('histGrid');
  if (!S.history.length) { c.innerHTML = '<div class="empty" style="grid-column:1/-1">Aucun semestre archive.</div>'; return; }
  c.innerHTML = S.history.map(h => {
    const men = mention(h.avg);
    return `<div class="hist-card">
      <div class="hist-card-name">${esc(h.name)}</div>
      <div class="hist-card-date">Archive le ${h.date}</div>
      <div class="hist-card-stats">
        <div class="hist-stat"><span class="hist-stat-val ${men.c}">${h.avg!==null?fmt(h.avg):'—'}</span><span class="hist-stat-lbl">Moy. gen.</span></div>
        <div class="hist-stat"><span class="hist-stat-val" style="color:var(--info)">${h.credits}</span><span class="hist-stat-lbl">Credits</span></div>
        <div class="hist-stat"><span class="hist-stat-val" style="color:var(--text)">${h.modules.length}</span><span class="hist-stat-lbl">Modules</span></div>
      </div>
      <div class="hist-card-actions">
        <button class="btn btn-ghost btn-sm" onclick="viewArchivedSemester('${h.id}')">Consulter</button>
        <button class="btn btn-sm" style="background:var(--red-light);color:var(--red-dark);border:none;font-family:'DM Sans',sans-serif;font-weight:600;cursor:pointer;border-radius:8px;display:inline-flex;align-items:center;gap:5px;" onclick="openConfirm('Supprimer ce semestre archive ?','Cette action est irreversible.','deleteHistory:${h.id}')">Supprimer</button>
      </div>
    </div>`;
  }).join('');
}

function renderHistoryBanner() {
  setT('archCurrentSem', S.profile.semester || '—');
  setT('archCurrentMods', S.modules.length + ' module(s)');
  const avg = calcGenAvg();
  setT('archCurrentAvg', avg!==null ? fmt(avg)+'/20' : '—');
}

function viewArchivedSemester(id) {
  const h = S.history.find(x => x.id === id);
  if (!h) return;
  // Show in a preview modal using pdf preview container
  const body = g('pdfPreviewBody');
  body.innerHTML = buildPreviewHTML(h.modules, h.profile, h.avg, h.credits);
  setT('mPDFPreview > .modal > .modal-hdr > h3', ''); // update title manually
  g('mPDFPreview').querySelector('.modal-hdr h3').textContent = 'Semestre : ' + h.name;
  // hide download button for archive view
  const foot = g('mPDFPreview').querySelector('.modal-foot');
  foot.innerHTML = '<button class="btn btn-ghost" onclick="closeModal(\'mPDFPreview\')">Fermer</button>';
  openModal('mPDFPreview');
}

/* ============================================================
   EXPORT PREVIEW
============================================================ */
function updatePreview() {
  const p = S.profile;
  setT('prevInst', p.institution || 'Votre Etablissement');
  setT('prevName', p.name || 'Nom etudiant');
  setT('prevProg', p.program || '');
  setT('prevSem', p.semester || '');
  const avg = calcGenAvg(), men = mention(avg);
  setT('prevAvg', avg!==null ? fmt(avg)+'/20' : '—');
  setT('prevCred', totalCred()+' ECTS');
  const me = g('prevMent'); me.textContent = men.l; me.className = men.c;
  g('previewTbl').innerHTML = buildPreviewHTML(S.modules, p);
}

function buildPreviewHTML(modules, profile, avgOverride, credOverride) {
  if (!modules.length) return '<p style="color:var(--text-light);text-align:center;padding:20px;font-size:.86rem">Aucun module a afficher.</p>';
  let h = '';
  for (const m of modules) {
    const ma = calcModAvg(m.subjects), mc = m.subjects.reduce((a,s)=>a+s.credits,0);
    h += `<div style="margin:16px 22px 0">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:7px 11px;background:#1a0d0b;border-radius:6px;margin-bottom:7px">
        <span style="font-weight:700;color:#fff;font-size:.87rem">${esc(m.name)}</span>
        <span style="color:#f5b7b1;font-size:.81rem">Moy: ${fmt(ma)} &middot; ${mc} credits</span>
      </div>
      <table style="width:100%;border-collapse:collapse;font-size:.81rem">
        <thead><tr style="background:#f5f2ef">
          <th style="text-align:left;padding:6px 10px;color:#9c8c87;font-size:.7rem;text-transform:uppercase">Matiere</th>
          <th style="padding:6px 10px;color:#9c8c87;font-size:.7rem;text-align:center">CC</th>
          <th style="padding:6px 10px;color:#9c8c87;font-size:.7rem;text-align:center">Examen</th>
          <th style="padding:6px 10px;color:#9c8c87;font-size:.7rem;text-align:center">Finale</th>
          <th style="padding:6px 10px;color:#9c8c87;font-size:.7rem;text-align:center">Credits</th>
        </tr></thead><tbody>`;
    for (const s of m.subjects) {
      const f = calcFinal(s.cc, s.exam);
      h += `<tr style="border-bottom:1px solid #f0ebe8">
        <td style="padding:7px 10px;font-weight:500">${esc(s.name)}</td>
        <td style="padding:7px 10px;text-align:center">${fmt(s.cc)}</td>
        <td style="padding:7px 10px;text-align:center">${fmt(s.exam)}</td>
        <td style="padding:7px 10px;text-align:center;font-weight:700;color:#c0392b">${fmt(f)}</td>
        <td style="padding:7px 10px;text-align:center">${s.credits}</td>
      </tr>`;
    }
    h += '</tbody></table></div>';
  }
  h += '<div style="height:14px"></div>';
  return h;
}

function openPDFPreview() {
  const body = g('pdfPreviewBody');
  body.innerHTML = `<div class="prev-card" style="border:none;box-shadow:none;">
    <div class="prev-hdr">
      <div class="prev-logo">
        <svg width="28" height="28" viewBox="0 0 28 28" fill="none"><rect width="28" height="28" rx="8" fill="rgba(255,255,255,.12)"/><path d="M14 5L21 9.5V14C21 18 18.5 21 14 23C9.5 21 7 18 7 14V9.5L14 5Z" fill="white" opacity=".9"/><path d="M11 14L13 16L17 12" stroke="#c0392b" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div><div class="prev-inst">${esc(S.profile.institution||'Votre Etablissement')}</div><div class="prev-tag">Releve de Notes — Document Officiel</div></div>
      </div>
      <div class="prev-meta">
        <div><strong>${esc(S.profile.name||'Etudiant')}</strong></div>
        <div style="color:rgba(255,255,255,.5);font-size:.82rem">${esc(S.profile.program||'')}</div>
        <div style="color:rgba(255,255,255,.5);font-size:.82rem">${esc(S.profile.semester||'')}</div>
      </div>
    </div>
    ${buildPreviewHTML(S.modules, S.profile)}
    <div class="prev-foot">
      <div>Moyenne Generale : <strong>${calcGenAvg()!==null?fmt(calcGenAvg())+'/20':'—'}</strong></div>
      <div>Credits : <strong>${totalCred()} ECTS</strong></div>
      <div>Mention : <strong class="${mention(calcGenAvg()).c}">${mention(calcGenAvg()).l}</strong></div>
    </div>
  </div>`;
  // restore download button
  const foot = g('mPDFPreview').querySelector('.modal-foot');
  foot.innerHTML = '<button class="btn btn-ghost" onclick="closeModal(\'mPDFPreview\')">Fermer</button><button class="btn btn-primary" onclick="exportPDF();closeModal(\'mPDFPreview\')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Telecharger PDF</button>';
  g('mPDFPreview').querySelector('.modal-hdr h3').textContent = 'Apercu du Releve PDF';
  openModal('mPDFPreview');
}

/* ============================================================
   EXPORT PDF
============================================================ */
function exportPDF() {
  const {jsPDF} = window.jspdf;
  if (!jsPDF) { toast('jsPDF non disponible','error'); return; }
  const p = S.profile, avg = calcGenAvg(), men = mention(avg), cred = totalCred();
  const doc = new jsPDF({unit:'mm',format:'a4'});
  const W = 210, M = 18;
  doc.setFillColor(24,16,15); doc.rect(0,0,W,40,'F');
  doc.setFillColor(192,57,43); doc.rect(0,40,W,2,'F');
  doc.setFont('helvetica','bold'); doc.setFontSize(15); doc.setTextColor(255,255,255);
  doc.text(p.institution||'Etablissement Academique',M,15);
  doc.setFont('helvetica','normal'); doc.setFontSize(8.5); doc.setTextColor(170,150,145);
  doc.text('RELEVE DE NOTES OFFICIEL',M,21);
  doc.setFont('helvetica','bold'); doc.setFontSize(10.5); doc.setTextColor(255,255,255);
  doc.text(p.name||'Etudiant',W-M,13,{align:'right'});
  doc.setFont('helvetica','normal'); doc.setFontSize(8.5); doc.setTextColor(170,150,145);
  if (p.program) doc.text(p.program,W-M,19,{align:'right'});
  if (p.semester) doc.text(p.semester,W-M,25,{align:'right'});
  doc.text('Edite le '+new Date().toLocaleDateString('fr-FR'),W-M,31,{align:'right'});
  let y = 52;
  for (const m of S.modules) {
    if (y > 250) { doc.addPage(); y = 18; }
    const ma = calcModAvg(m.subjects), mc = m.subjects.reduce((a,s)=>a+s.credits,0);
    doc.setFillColor(241,235,232); doc.roundedRect(M,y,W-M*2,9,2,2,'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(9.5); doc.setTextColor(26,13,11);
    doc.text(m.name,M+4,y+6);
    doc.setTextColor(150,40,27);
    doc.text('Moy: '+fmt(ma)+'/20  |  '+mc+' credits',W-M-4,y+6,{align:'right'});
    y += 13;
    const cols = [M,M+70,M+95,M+120,M+148];
    doc.setFillColor(24,16,15); doc.rect(M,y,W-M*2,7.5,'F');
    doc.setFont('helvetica','bold'); doc.setFontSize(7); doc.setTextColor(190,175,170);
    ['MATIERE','CC /20','EXAM /20','FINALE','CREDITS'].forEach((h,i) => doc.text(h,cols[i]+2,y+5));
    y += 9;
    doc.setFont('helvetica','normal'); doc.setFontSize(8.5);
    for (const s of m.subjects) {
      if (y > 270) { doc.addPage(); y = 18; }
      const f = calcFinal(s.cc,s.exam), bad = f < 10;
      doc.setTextColor(bad?146:26,bad?43:13,bad?33:11);
      doc.text(s.name.substring(0,32),cols[0]+2,y+4.5);
      doc.setTextColor(55,55,55);
      doc.text(fmt(s.cc),cols[1]+2,y+4.5);
      doc.text(fmt(s.exam),cols[2]+2,y+4.5);
      doc.setFont('helvetica','bold'); doc.setTextColor(192,57,43);
      doc.text(fmt(f),cols[3]+2,y+4.5);
      doc.setFont('helvetica','normal'); doc.setTextColor(55,55,55);
      doc.text(String(s.credits),cols[4]+2,y+4.5);
      doc.setDrawColor(225,218,213); doc.line(M,y+7.5,W-M,y+7.5);
      y += 8.5;
    }
    y += 7;
  }
  if (y > 242) { doc.addPage(); y = 18; }
  doc.setFillColor(24,16,15); doc.roundedRect(M,y,W-M*2,22,3,3,'F');
  doc.setFillColor(192,57,43); doc.roundedRect(M,y,4,22,2,2,'F');
  doc.setFont('helvetica','bold'); doc.setFontSize(11.5); doc.setTextColor(255,255,255);
  doc.text('Moyenne Generale : '+(avg!==null?fmt(avg):'—')+'/20',M+10,y+9.5);
  doc.setFontSize(8.5); doc.setTextColor(175,155,150);
  doc.text('Credits totaux : '+cred+' ECTS   |   Mention : '+men.l,M+10,y+17);
  doc.save('releve_'+(p.name||'etudiant').replace(/\s+/g,'_').toLowerCase()+'.pdf');
  toast('PDF exporte','success');
}

/* ============================================================
   EXPORT CSV
============================================================ */
function exportCSV() {
  const p = S.profile, avg = calcGenAvg(), men = mention(avg);
  const q = s => '"'+String(s).replace(/"/g,'""')+'"';
  let csv = q('CampusEdge Pro - Releve de Notes')+'\n'+q('Etudiant')+','+q(p.name||'')+'\n'+q('Filiere')+','+q(p.program||'')+'\n'+q('Semestre')+','+q(p.semester||'')+'\n'+q('Etablissement')+','+q(p.institution||'')+'\n'+q('Date')+','+q(new Date().toLocaleDateString('fr-FR'))+'\n\n';
  csv += [q('Module'),q('Matiere'),q('CC'),q('Examen'),q('Finale'),q('Credits'),q('Moy. Module')].join(',')+'\n';
  for (const m of S.modules) {
    const ma = calcModAvg(m.subjects);
    for (const s of m.subjects) { const f = calcFinal(s.cc,s.exam); csv += [q(m.name),q(s.name),q(fmt(s.cc)),q(fmt(s.exam)),q(fmt(f)),q(s.credits),q(fmt(ma))].join(',')+'\n'; }
  }
  csv += '\n'+q('RESUME')+'\n'+q('Moyenne Generale')+','+q(avg!==null?fmt(avg):'—')+'\n'+q('Credits ECTS')+','+q(totalCred())+'\n'+q('Mention')+','+q(men.l)+'\n';
  const blob = new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob), a = document.createElement('a');
  a.href = url; a.download = 'releve_'+(p.name||'etudiant').replace(/\s+/g,'_').toLowerCase()+'.csv';
  a.click(); URL.revokeObjectURL(url);
  toast('CSV exporte','success');
}

/* ============================================================
   HELPERS
============================================================ */
function openModal(id) { g(id)?.classList.add('active'); }
function closeModal(id) { g(id)?.classList.remove('active'); }
function showErr(id,msg) { const e=g(id); e.textContent=msg; e.style.display='block'; }
function g(id) { return document.getElementById(id); }
function setT(id,val) { const e=g(id); if(e) e.textContent=val; }
function sv(id,val) { const e=g(id); if(e) e.value=val; }
function gv(id) { const e=g(id); return e?e.value:''; }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function uid() { return 'id_'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(ov => {
  if (ov.id === 'mSetup') return;
  ov.addEventListener('click', function(e) { if(e.target === this) closeModal(this.id); });
});

let toastTm = null;
function toast(msg,type='') {
  const e=g('toast'); e.textContent=msg;
  e.className='toast show'+(type?' toast-'+type:'');
  if(toastTm) clearTimeout(toastTm);
  toastTm = setTimeout(()=>e.classList.remove('show'),2800);
}
</script>
</body>
</html>
